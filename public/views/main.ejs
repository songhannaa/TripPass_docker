<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TripPass</title>
  <link rel="stylesheet" href="../css/main.css" type="text/css">
  <link rel="stylesheet" href="../css/reset.css" type="text/css">
</head>
<body>
  <div id="wrap">
    <div id="overlay" class="overlay"></div>
    <div class="sidebar">
        <div class="sidebar-top">
            <div class="logo">
                <a href="/main">
                    <img src="../image/TripPasslogo.png" alt="íŠ¸ë¦½íŒ¨ìŠ¤ë¡œê³ ">
                    <span>TripPass</span>
                </a>
            </div>
            <button class="newtrip" id="openPopup">
                New Trip +
            </button>
        </div>
        <div class="sidebar-bottom">
            <div class="user">
                <img src="data:image/png;base64,<%= user.profile %>" alt="ì‚¬ìš©ì ì‚¬ì§„">
                <div class="user-name"><a href="/mypage"><%= user.name %></a></div>
            </div>
        </div>
    </div>
    <div class="section-center">
        <div class="banner-container">
            <img src="<%= imageUrl %>" alt="ë°°ë„ˆ ì´ë¯¸ì§€">
            <span><p><%= bannerStr %></p></span>
        </div>
        <div class="map-container">
            <div class="map-title">
                TripPass Map
            </div>
            <div class="map-area">
                <!-- êµ¬ê¸€ ì§€ë„ ì˜ì—­ -->
                <!-- data ì—†ëŠ” ê²½ìš° -->
                <div class="map-alert">
                    ğŸ˜­ <br>
                    ì•„ì§ êµ¬ê¸€ë§µ ì—°ë™ì„ ëª»í—€ì–´ìš”! <br>
                    ì¡°ê¸ˆë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”!
                </div>
            </div>
        </div>
        <div class="mate-container">
            <div class="mate-title">
                TripPass Mate
            </div>
            <div class="mate-area">
                <div class="mate-alert">
                    ğŸ˜­ <br>
                    ì•„ì§ ë©”ì´íŠ¸ê°€ ì—†ì–´ìš”! <br>
                    ë‚˜ë§Œì˜ ë§¤ì¹­ ë©”ì´íŠ¸ë¥¼ ì°¾ì•„ë³¼ê¹Œìš”?
                </div>
                <!-- <ul class="mate-list">
                    <li>
                        <div class="mate-list-title">
                            <span class="mate-list-sub-title">ë°”ë¥´ì…€ë¡œë‚˜ ë§›ì§‘ ë©”ì´íŠ¸</span>
                            <span></span>
                        </div>
                        <div class="mate-list-count">
                            <span>2</span>
                            <span>mate</span>
                        </div>
                        <div class="mate-list-user">
                            <ul class="mate-list-user-profile">
                                <li>
                                    <img src="../image/pic.png" alt="ë©”ì´íŠ¸ ìœ ì € í”„ë¡œí•„ ì‚¬ì§„">
                                    <span>ì„¸ì˜ , </span>
                                </li>
                                <li>
                                    <img src="../image/pic.png" alt="ë©”ì´íŠ¸ ìœ ì € í”„ë¡œí•„ ì‚¬ì§„">
                                    <span>í•œë‚˜</span>
                                </li>
                            </ul>
                        </div>
                    </li>
                    <li>
                        <div class="mate-list-title">
                            <span class="mate-list-sub-title">í”¼ì¹´ì†Œ ë¯¸ìˆ ê´€ UBER</span>
                            <span></span>
                        </div>
                        <div class="mate-list-count">
                            <span>2</span>
                            <span>mate</span>
                        </div>
                        <div class="mate-list-user">
                            <ul class="mate-list-user-profile">
                                <li>
                                    <img src="../image/pic.png" alt="ë©”ì´íŠ¸ ìœ ì € í”„ë¡œí•„ ì‚¬ì§„">
                                    <span>ì„¸ì˜ , </span>
                                </li>
                                <li>
                                    <img src="../image/pic.png" alt="ë©”ì´íŠ¸ ìœ ì € í”„ë¡œí•„ ì‚¬ì§„">
                                    <span>í•œë‚˜</span>
                                </li>
                            </ul>
                        </div>
                    </li>
                    
                </ul> -->
            </div>
        </div>
    </div>
    <div class ="right">
        <div class="calendar">
          <div class="calendar-header">
            <span><%= monthNames[currentMonth] %></span>
          </div>
          
          <div class="calendar-body">
            <div class="calendar-weekdays">
              <div>Su</div>
              <div>Mo</div>
              <div>Tu</div>
              <div>We</div>
              <div>Th</div>
              <div>Fr</div>
              <div>Sa</div>
            </div>
            <div class="calendar-days">
              <% for(let i = 0; i < firstDayOfMonth; i++) { %>
              <div class="empty"></div>
              <% } %> <% for(let i = 1; i <= lastDateOfMonth; i++) { %>
              <div class="calendar-day" data-day="<%= i %>"><%= i %></div>
              <% } %>
            </div>
          </div>
        </div>
    
        <div class="right-bottom">
          <div class="right-bottom-nothing">ì˜¤ëŠ˜ì˜ ì—¬í–‰ì„<br> ì‹œì‘í•´ë³¼ê¹Œìš”?</div> 
          </div>
    
        <div id="popup" class="popup">
          <div class="popup-close"> X </div>
          <div class="popup-content">
            <h2 align="center">New Trip</h2>
            <div class="trip-data">
              <p>Title</p>
              <input type="text" id="title" placeholder="ì œëª©" />
            </div>
            <div class="trip-data">
              <p>Start Date</p>
              <input type="date" id="startdate" />
            </div>
            <div class="trip-data">
              <p>End Date</p>
              <input type="date" id="enddate" />
            </div>
            <div class="trip-data">
            <p>Image</p><input type="file" id="image" accept="image/*" />
    
            </div>
            <div class="image-preview"></div>
            <canvas id="imageCanvas" width="400" height="300"></canvas>
          </div>
          <div class="popup-buttons">
            <button id="save">ì €ì¥</button>
            <button id="cancel">ì·¨ì†Œ</button>
          </div>
          </div>    
        </div>
    </body>
    <script>
        const startDateInput = document.getElementById("startdate");
        const endDateInput = document.getElementById("enddate");
        document.querySelectorAll(".calendar-day").forEach(day => {
          day.addEventListener("click", function() {
              
            const day = Number(this.getAttribute("data-day"));
            const date = new Date(<%=currentYear%>, <%=currentMonth%>, day +1);
            const selectDate = date.toISOString().split('T')[0]; // 'YYYY-MM-DD' í˜•ì‹ìœ¼ë¡œ ë³€í™˜
            console.log(selectDate);
            fetch(`http://<%=mylocalhost%>:3500/getTripPlanSQL?select_date=${selectDate}`)
              .then(response => response.json())
              .then(data => {
                const rightBottom = document.querySelector(".right-bottom");
                rightBottom.innerHTML = "<div class= 'right-bottom-title'>Today's Trip</div>"; // ê¸°ì¡´ ë‚´ìš©ì„ ì§€ìš°ê³ 
                if (data.result && data.result.length > 0) {
                  data.result.forEach(plan => {
                    const planDiv = document.createElement("div");
                    const hours = Math.floor(plan.triptime/3600).toString().padStart(2, '0');
                    const minutes = ((plan.triptime%3600) / 60).toString().padStart(2, '0');
                    planDiv.innerHTML = `
                <div class = 'plantime'>
                  ${hours}:${minutes}
                </div>
                <div class = 'planplace'>
                  <span class = "check">âœ” &nbsp; </span>  ${plan.place} <br>
                </div>
                <div class = "plannote">- ${plan.note} </div> 
              `;
                    rightBottom.appendChild(planDiv);
                  });
                } else {
                  rightBottom.innerHTML = "<div class='right-bottom-nothing'>ì˜¤ëŠ˜ì˜ ì—¬í–‰ì„<br> ì‹œì‘í•´ë³¼ê¹Œìš”?</div>";
                }
              })
              .catch(error => {
              });
          });
        });

      const overlay = document.getElementById("overlay");
      const openPopupButton = document.getElementById("openPopup");
      const popup = document.getElementById("popup");
      const closePopupButton = document.querySelector(".popup-close");
      const saveButton = document.getElementById("save");
      const cancelButton = document.getElementById("cancel");
      const titleInput = document.getElementById("title");
      const imageInput = document.getElementById("image");
      const imagePreview = document.querySelector(".image-preview");
      const canvas = document.getElementById("imageCanvas");
      const ctx = canvas.getContext("2d");

      openPopupButton.addEventListener("click", () => {
        overlay.style.display = "block";
        popup.style.display = "block";
        imagePreview.innerHTML = ""; // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ì´ˆê¸°í™”
      });

      closePopupButton.addEventListener("click", () => {
        popup.style.display = "none";
        overlay.style.display = "none";
      });

      cancelButton.addEventListener("click", () => {
        popup.style.display = "none";
        overlay.style.display = "none";
      });

      imageInput.addEventListener("change", function (e) {
        const file = e.target.files[0];
        if (file && file.type.startsWith("image/")) {
          const reader = new FileReader();

          reader.onload = function (e) {
            const image = new Image();
            image.onload = function () {
              ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
            };
            image.src = e.target.result;
          };
          reader.readAsDataURL(file);
        } else {
          imagePreview.innerHTML = "ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.";
        }
      });
      
      saveButton.addEventListener("click", () => {
  const title = titleInput.value;
  const startDate = startDateInput.value;
  const endDate = endDateInput.value;
  const imageFile = imageInput.files[0];
  
  if (imageFile) {
    const formData = new FormData();
    formData.append("title", title);
    formData.append("startdate", startDate);
    formData.append("enddate", endDate);
    formData.append("banner", imageFile);

    const xhr = new XMLHttpRequest();
    xhr.open("POST", "http://<%=mylocalhost%>:3500/insertUserTripSQL");
    xhr.onreadystatechange = function() {
      if (xhr.readyState === 4) {
        if (xhr.status === 200) {
          const data = JSON.parse(xhr.responseText);
          alert("ì—¬í–‰ ì •ë³´ ì €ì¥ ì„±ê³µ.");
          popup.style.display = "none";
          location.reload();
        } else {
          alert("ì—¬í–‰ ì •ë³´ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      }
    };
    xhr.send(formData);
  } else {
    const data = {
      title: title,
      startdate: startDate,
      enddate: endDate
    };
    const xhr = new XMLHttpRequest();
    xhr.open("POST", "http://<%=mylocalhost%>:3500/insertUserTripSQL");
    xhr.setRequestHeader("Content-Type", "application/json");
    xhr.onreadystatechange = function() {
      if (xhr.readyState === 4) {
        if (xhr.status === 200) {
          const responseData = JSON.parse(xhr.responseText);
          alert("ì—¬í–‰ ì •ë³´ ì €ì¥ ì„±ê³µ.");
          popup.style.display = "none";
          location.reload();
        } else {
          alert("ì—¬í–‰ ì •ë³´ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      }
    };
    xhr.send(JSON.stringify(data));
  }
});
  </script>
</html>